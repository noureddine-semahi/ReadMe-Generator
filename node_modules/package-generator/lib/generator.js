const glob = require('glob').sync
const path = require('path')
const fs = require('fs-extra')
const Handlebars = require('handlebars')

Handlebars.registerHelper('titleize', titleize)

module.exports = function (metadata = {}, src, dest) {
  fs.emptyDirSync(dest)
  const files = glob('**', {
    dot: true,
    nodir: true,
    cwd: src
  })
  files.forEach(file => {
    let str = fs.readFileSync(path.join(src, file), 'utf-8')
    if (/{{([^{}]+)}}/g.test(str)) {
      str = generate(str, metadata)
    }
    fs.outputFileSync(path.join(dest, file), str, 'utf-8')
  })
}

function generate (str, context) {
  return Handlebars.compile(str)(context)
}

module.exports.generate = generate

function titleize (val) {
  if (typeof val !== 'string' || val === '') {
    return val
  }
  return val.split(/[^A-Za-z0-9]+/).map(word => {
    return word.charAt(0).toUpperCase() + word.slice(1)
  })
    .join(' ')
    .replace(/([a-z])([A-Z])/g, '$1 $2')
}

module.exports.titleize = titleize
