#!/usr/bin/env node
const fs = require('fs-extra')
const path = require('path')
const inquirer = require('inquirer')
const chalk = require('chalk')
const symbols = require('log-symbols')
const program = require('commander')
const util = require('../lib/util')

const { version } = require('../package')
program.version(version, '-v, --version')
  .usage('<package-name>')
  .option('-s, --skip', 'Skip dependencies install and git init')
  .arguments('<package-name>')
  .action(run)
program.parse(process.argv)

if (program.args.length === 0) {
  program.help()
}
async function run (name, cmd) {
  name = path.basename(name)
  if (fs.existsSync(name)) {
    const { confirm } = await inquirer.prompt({
      type: 'confirm',
      name: 'confirm',
      message: `Directory ${name} exist, overwrite it?`,
      default: false
    })
    if (!confirm) {
      return
    }
  }
  const context = {
    name
  }
  try {
    const dest = await util.downloadAndGenerate(context)
    console.log(symbols.success, 'Creating package in', chalk.yellow(dest))
    if (!cmd.skip) {
      util.initPackage(dest)
    }
    console.log()
    console.log(' Get started with the following commands:')
    console.log(chalk.cyan(` ${chalk.gray('$')} cd ${name}`))
    console.log()
  } catch (error) {
    console.log(symbols.error, chalk.red(error))
  }
}
